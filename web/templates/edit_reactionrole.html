<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Reaction Role Menu Setup</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="../../../static/images/favicon.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 1000px; margin: 2rem auto; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); padding: 2rem; }
        .option-card { border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.04); margin-bottom: 1.2em; }
        .option-list { margin-bottom: 2em; }
        .form-label { font-weight: 500; }
        .actions { margin-top: 2em; }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="mb-4"><i class="bi bi-emoji-smile me-2"></i>Reaction Role Menu Setup</h2>
        <div class="mb-3">
            <span class="badge bg-secondary">ID: {{ menu_id }}</span>
        </div>
        <form id="reactionForm" method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="mb-3">
                <label class="form-label">Label <span class="text-danger">*</span></label>
                <input type="text" class="form-control" name="label" value="{{ config.get('label', '') }}" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Description <span class="text-danger">*</span></label>
                <textarea class="form-control" name="description" rows="3" required>{{ config.get('description', '').replace('\n', '<br>')|safe }}</textarea>
            </div>
            <div class="option-list">
                <h4 class="mb-3">Options <span class="text-danger">*</span></h4>
                <div id="options"></div>
                <button type="button" class="btn btn-outline-primary" onclick="addOption()">
                    <i class="bi bi-plus-circle"></i> Add Option
                </button>
            </div>
            <input type="hidden" name="config_json" id="config_json">
            <div class="actions text-center">
                <button type="button" class="btn btn-lg btn-primary" id="saveSendBtn">
                    <i class="bi bi-save me-2"></i>Save &amp; Send to Discord
                </button>
            </div>
        </form>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let API_URL = "{{ API_URL }}";
        let options = {{ config.get('options', []) | tojson }};
        function renderOptions() {
            const container = document.getElementById('options');
            container.innerHTML = '';
            options.forEach((opt, idx) => {
                container.innerHTML += `
                <div class="card option-card p-3">
                    <div class="row g-2 align-items-center">
                        <div class="col-md-2">
                            <label class="form-label">Emoji</label>
                            <input type="text" class="form-control" value="${opt.emoji || ''}" onchange="updateOption(${idx}, 'emoji', this.value)">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Label <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" value="${opt.label || ''}" onchange="updateOption(${idx}, 'label', this.value)" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Description <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" value="${opt.description || ''}" onchange="updateOption(${idx}, 'description', this.value)" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Role <span class="text-danger">*</span></label>
                            <select class="form-select" onchange="updateOption(${idx}, 'role', this.value)" required>
                                <option value="">Choose a role...</option>
                                {% for role in roles %}
                                <option value="{{ role.id }}" ${opt.role == '{{ role.id }}' ? 'selected' : ''}>{{ role.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-1 text-end">
                            <button type="button" class="btn btn-outline-danger" onclick="removeOption(${idx})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>`;
            });
        }
        function addOption() {
            options.push({emoji:'', label:'', description:'', role:''});
            renderOptions();
        }
        function removeOption(idx) {
            options.splice(idx, 1);
            renderOptions();
        }
        function updateOption(idx, key, value) {
            options[idx][key] = value;
        }
        function isValidEmoji(emoji) {
            // Unicode emoji: single character, not empty, not just text
            if (!emoji) return true;
            // Custom emoji: <a:name:id> or <:name:id> or name:id
            if (/^<a?:\w+:\d+>$/.test(emoji) || /^\w+:\d+$/.test(emoji)) return true;
            // Basic Unicode emoji (rough check)
            if (emoji.length <= 3 && /\p{Emoji}/u.test(emoji)) return true;
            return false;
        }
        function validateForm() {
            const label = document.querySelector('[name=label]').value.trim();
            const description = document.querySelector('[name=description]').value.trim();
            if (!label || !description) {
                alert("Please fill out all required fields.");
                return false;
            }
            if (!options.length) {
                alert("Please add at least one option.");
                return false;
            }
            for (let i = 0; i < options.length; i++) {
                const opt = options[i];
                if (!opt.label || !opt.description || !opt.role) {
                    alert("All options must have a label, description, and role.");
                    return false;
                }
                if (opt.emoji && !isValidEmoji(opt.emoji)) {
                    alert(`Reaction Role ${i + 1}: Invalid emoji format. Use a Unicode emoji or custom emoji like name:id.`);
                    return false;
                }
            }
            return true;
        }
        async function saveAndSend() {
            if (!validateForm()) return;
            // Sanitize options: remove emoji if empty
            let sanitizedOptions = options.map(opt => {
                let newOpt = { ...opt };
                if (!newOpt.emoji || newOpt.emoji.trim() === "") {
                    delete newOpt.emoji;
                }
                return newOpt;
            });
            document.getElementById('config_json').value = JSON.stringify({
                label: document.querySelector('[name=label]').value,
                description: document.querySelector('[name=description]').value,
                options: sanitizedOptions
            });
            let formData = new FormData(document.getElementById('reactionForm'));
            let csrfToken = document.querySelector('[name="csrf_token"]').value;
            formData.append('csrf_token', csrfToken);
            try {
                let saveResp = await fetch(window.location.pathname, {
                    method: "POST",
                    body: formData
                });
                if (!saveResp.ok) {
                    let text = await saveResp.text();
                    alert("Failed to save config: " + text);
                    return;
                }
            } catch (err) {
                alert("Network error while saving config: " + err);
                return;
            }
            try {
                let sendResp = await fetch(`${API_URL}/send_role_menu/{{ menu_id }}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ menu_id: "{{ menu_id }}" })
                });
                let result = await sendResp.json();
                if (sendResp.ok && result.success) {
                    alert("Menu sent to Discord!");
                } else {
                    alert("Bot error: " + (result.error || "Unknown error"));
                }
            } catch (err) {
                alert("Network error while sending to Discord: " + err);
            }
        }
        document.getElementById('saveSendBtn').onclick = saveAndSend;
        renderOptions();
    </script>
    <footer style="margin-top: 3rem; padding-top: 1rem; border-top: 1px solid #ccc; font-size: 0.9rem; color: #555;">
	  <p>
		&copy; 2025 RuleKeeper. All rights reserved. |
		<a href="/privacy-policy" style="color: #0066cc; text-decoration: none;">Privacy Policy</a> |
		<a href="/terms-of-service" style="color: #0066cc; text-decoration: none;">Terms of Service</a> |
		<a href="/end-user-license-agreement" style="color: #0066cc; text-decoration: none;">End User License Agreement</a>
	  </p>
	</footer>
</body>
</html>