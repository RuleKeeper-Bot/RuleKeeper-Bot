<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Role Menus Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="../../static/images/favicon.ico">
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        .menu-card { border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); margin-bottom: 1.5em; }
        .menu-type-badge { font-size: 0.9em; }
        .menu-id { font-size: 0.95em; color: #888; }
        .menu-actions { margin-top: 1em; }
        .menu-label { font-weight: bold; font-size: 1.1em; }
        .menu-description { color: #555; }
        .empty-state { color: #888; text-align: center; margin-top: 3em; }
        .dropdown-menu .dropdown-item { display: flex; align-items: center; }
        .dropdown-menu .dropdown-item i { margin-right: 0.5em; }
    </style>
</head>
<body>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    <div class="container">
        <h2 class="mb-4">Role Menus for {{ guild.name}}</h2>
        <div class="mb-3 d-flex align-items-center gap-2">
            <a href="/dashboard/{{ guild_id }}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
            <!-- Add Button with Dropdown -->
            <div class="dropdown">
                <button class="btn btn-success btn-sm dropdown-toggle" type="button" id="addMenuDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-plus-circle"></i> Add
                </button>
                <ul class="dropdown-menu" aria-labelledby="addMenuDropdown">
                    <li>
                        <a class="dropdown-item" href="#" onclick="showChannelSelect('dropdown')">
                            Dropdown
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" onclick="showChannelSelect('button')">
                            Buttons
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" onclick="showChannelSelect('reactionrole')">
                            Reaction Role
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        <!-- Channel select modal -->
        <div class="modal fade" id="channelSelectModal" tabindex="-1" aria-labelledby="channelSelectModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <form id="createMenuForm" onsubmit="return createMenu(event)">
                <div class="modal-header">
                  <h5 class="modal-title" id="channelSelectModalLabel">Select Channel</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3">
                    <label for="channelSelect" class="form-label">Channel</label>
                    <select class="form-select" id="channelSelect" name="channel_id" required>
                      <option value="">Select a channel...</option>
                      {% for channel in channels %}
                        <option value="{{ channel.id }}">#{{ channel.name }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <input type="hidden" id="menuTypeInput" name="menu_type" value="">
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-primary">Create</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        {% if menus and menus|length > 0 %}
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                {% for menu in menus %}
                <div class="col">
                    <div class="card menu-card h-100">
                        <div class="card-body">
                            <span class="menu-type-badge badge bg-info text-dark mb-2">
                                {{ menu.type|capitalize }}
                            </span>
                            <div class="menu-label mb-1">
                                {{ (menu.config | json_loads).label if menu.config else '' or 'No label set' }}
                            </div>
                            <div class="menu-description mb-2">
                                {{ (menu.config | json_loads).description if menu.config else '' or 'No description set' }}
                            </div>
                            <div class="menu-id mb-2">
                                <span class="badge bg-secondary">ID: {{ menu.id }}</span>
                            </div>
                            <div>
                              <span class="text-muted">Channel:</span>
                              <span>
                                {% set channel_name = menu.channel_id | get_channel_name(channels) %}
                                {% if channel_name %}
                                  <span class="fw-bold text-primary">#{{ channel_name }}</span>
                                {% else %}
                                  <span class="text-danger">Unknown</span>
                                {% endif %}
                              </span>
                            </div>
                            <div class="menu-actions d-flex gap-2 flex-wrap">
                                <a href="/dashboard/{{ guild_id }}/{{ menu.type }}/{{ menu.id }}" class="btn btn-sm btn-primary">
                                    <i class="bi bi-pencil-square"></i> Edit
                                </a>
                                <button type="button" class="btn btn-sm btn-danger" onclick="deleteMenu('{{ menu.id }}', '{{ menu.type }}')">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                                {% if menu.message_id %}
                                <a href="https://discord.com/channels/{{ guild_id }}/{{ menu.channel_id }}/{{ menu.message_id }}" target="_blank" class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-discord"></i> View in Discord
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <i class="bi bi-ui-checks-grid" style="font-size:2em;"></i>
                <p>No role menus have been created for this server yet.</p>
                <p>
                    Use the Add button at the top of the page or use the <code>/create_dropdown</code>, <code>/create_reactionrole</code>, or <code>/create_button</code> command in Discord to start!
                </p>
            </div>
        {% endif %}
    </div>
    <footer style="margin-top: 3rem; padding-top: 1rem; border-top: 1px solid #ccc; font-size: 0.9rem; color: #555;">
      <p>
        &copy; 2025 RuleKeeper. All rights reserved. |
        <a href="/privacy-policy" style="color: #0066cc; text-decoration: none;">Privacy Policy</a> |
        <a href="/terms-of-service" style="color: #0066cc; text-decoration: none;">Terms of Service</a> |
        <a href="/end-user-license-agreement" style="color: #0066cc; text-decoration: none;">End User License Agreement</a>
      </p>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const guildId = "{{ guild_id }}";
        // Show the channel select modal and set menu type
        function showChannelSelect(menuType) {
            document.getElementById('menuTypeInput').value = menuType;
            document.getElementById('channelSelect').value = "";
            var modal = new bootstrap.Modal(document.getElementById('channelSelectModal'));
            modal.show();
        }

        // Handle menu creation
        async function createMenu(event) {
            event.preventDefault();
            const menuType = document.getElementById('menuTypeInput').value;
            const channelId = document.getElementById('channelSelect').value;
            if (!menuType || !channelId) {
                alert("Please select a channel.");
                return false;
            }
            try {
                const response = await fetch(`/api/${guildId}/create_role_menu`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token() }}"
                    },
                    body: JSON.stringify({
                        guild_id: "{{ guild_id }}",
                        menu_type: menuType,
                        channel_id: channelId
                    })
                });
                const data = await response.json();
                if (data.success && data.setup_url) {
                    window.location.href = data.setup_url;
                } else {
                    alert(data.error || "Failed to create menu.");
                }
            } catch (err) {
                alert("Error creating menu: " + err);
            }
            // Hide modal
            var modal = bootstrap.Modal.getInstance(document.getElementById('channelSelectModal'));
            if (modal) modal.hide();
            return false;
        }
    // Delete menu function
    async function deleteMenu(menuId, menuType) {
        if (!confirm('Are you sure you want to delete this role menu? This cannot be undone.')) return;
        try {
            const response = await fetch(`/api/${guildId}/role_menus/${menuId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({ menu_type: menuType })
            });
            let data = null;
            if (response.ok) {
                try {
                    data = await response.json();
                } catch (e) {
                    // Not JSON, treat as error
                    alert('Failed to delete role menu: Server did not return JSON.');
                    return;
                }
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.error || 'Failed to delete role menu.');
                }
            } else {
                // Try to get error text
                const text = await response.text();
                alert('Failed to delete role menu.\n' + text);
            }
        } catch (err) {
            alert('Error deleting menu: ' + err);
        }
    }
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
</body>
</html>